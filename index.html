<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PRAJWAL JANA'S - Crypto Futures Trading Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .brand-title {
            font-size: 1.8rem;
            color: #4ecdc4;
            text-transform: uppercase;
            letter-spacing: 3px;
            border-bottom: 3px solid #4ecdc4;
            display: inline-block;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            opacity: 0.8;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .calculator {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .exchange-rate-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 25px;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .rate-label {
            color: #4ecdc4;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .rate-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            color: #4ecdc4;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }
        
        .form-group select {
            appearance: none;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="%23ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m6 8 4 4 4-4"/></svg>');
            background-position: right 12px center;
            background-repeat: no-repeat;
            padding-right: 40px;
        }
        
        .form-group select option {
            background: #2c2c54;
            color: #fff;
            padding: 10px;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 8px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #4ecdc4;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #fff;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }
        
        .toggle-switch.active::after {
            left: 32px;
        }
        
        .toggle-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .custom-entry-exit,
        .points-calculator,
        .leverage-analysis,
        .capital-percentage-analysis {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .custom-entry-exit h3,
        .points-calculator h3,
        .leverage-analysis h3,
        .capital-percentage-analysis h3 {
            color: #4ecdc4;
            margin-bottom: 15px;
        }
        
        .entry-exit-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .results {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-label {
            color: #4ecdc4;
            font-weight: 600;
        }
        
        .result-value {
            font-weight: bold;
            font-size: 1.1rem;
            text-align: right;
        }
        
        .scenarios-container {
            margin-top: 30px;
        }
        
        .scenarios-container h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .scenarios-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        
        .scenarios-table th {
            background: rgba(78, 205, 196, 0.2);
            padding: 12px 6px;
            color: #4ecdc4;
            font-weight: 600;
            text-align: left;
            font-size: 0.85rem;
        }
        
        .scenarios-table td {
            padding: 10px 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.8rem;
        }
        
        .scenarios-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .profit {
            color: #4ecdc4;
            font-weight: bold;
        }
        
        .loss {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .currency-display {
            opacity: 0.7;
            font-size: 0.85rem;
            display: block;
            margin-top: 2px;
        }
        
        .warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #ffc107;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4ecdc4;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .analysis-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .analysis-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .analysis-tab.active {
            background: rgba(78, 205, 196, 0.2);
            border-color: #4ecdc4;
            color: #4ecdc4;
        }
        
        .analysis-content {
            display: none;
        }
        
        .analysis-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .form-row, .entry-exit-row {
                grid-template-columns: 1fr;
            }
            
            .scenarios-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .calculator {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .brand-title {
                font-size: 1.4rem;
            }
            
            .analysis-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand-title">PRAJWAL JANA'S</div>
            <h1>Crypto Futures Trading Calculator</h1>
            <p class="subtitle">Advanced trading calculator with Long/Short positions, live prices, and comprehensive P&L scenarios</p>
        </div>
        
        <div class="calculator">
            <div class="exchange-rate-display">
                <div class="rate-label">Live USD → INR Exchange Rate</div>
                <div class="rate-value" id="exchangeRateDisplay">Loading...</div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="contract">Select Contract</label>
                    <select id="contract">
                        <option value="bitcoin">BTCUSD</option>
                        <option value="ethereum">ETHUSD</option>
                        <option value="binancecoin">BNBUSD</option>
                        <option value="solana">SOLUSD</option>
                        <option value="ripple">XRPUSD</option>
                        <option value="cardano">ADAUSD</option>
                        <option value="polkadot">DOTUSD</option>
                        <option value="chainlink">LINKUSD</option>
                        <option value="avalanche-2">AVAXUSD</option>
                        <option value="dogecoin">DOGEUSD</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="manualPriceToggle"> Enter Current Price Manually
                    </label>
                    <input type="number" id="entryPrice" readonly placeholder="Loading live price..." style="margin-top: 8px;">
                    <span id="priceStatus" class="live-indicator"></span>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="capitalUSD">Capital (USD)</label>
                    <input type="number" id="capitalUSD" placeholder="Enter capital in USD" step="0.01">
                </div>
                <div class="form-group">
                    <label for="capitalINR">Capital (INR)</label>
                    <input type="number" id="capitalINR" placeholder="Enter capital in INR" step="0.01">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Position Direction</label>
                    <div class="toggle-container">
                        <span class="toggle-label">Long</span>
                        <div class="toggle-switch" id="directionToggle"></div>
                        <span class="toggle-label">Short</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Order Type</label>
                    <div class="toggle-container">
                        <span class="toggle-label">Taker (0.05%)</span>
                        <div class="toggle-switch" id="orderTypeToggle"></div>
                        <span class="toggle-label">Maker (0.02%)</span>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="leverage">Leverage</label>
                    <select id="leverage">
                        <option value="1">1x</option>
                        <option value="2">2x</option>
                        <option value="5">5x</option>
                        <option value="10" selected>10x</option>
                        <option value="20">20x</option>
                        <option value="50">50x</option>
                        <option value="100">100x</option>
                        <option value="200">200x</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="number" id="customLeverage" placeholder="Enter custom leverage (1-200)" min="1" max="200" style="display: none; margin-top: 10px;">
                </div>
                <div class="form-group">
                    <div id="leverageWarning" style="display: none;">
                        <div class="warning">⚠️ High leverage trading carries extreme risk of liquidation!</div>
                    </div>
                </div>
            </div>
            
            <!-- Original Custom Entry/Exit Feature -->
            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="customEntryExitToggle"> Custom Entry & Exit Points
                    </label>
                </div>
            </div>
            <div id="customEntryExitPanel" class="custom-entry-exit" style="display: none;">
                <h3>Manual Entry & Exit Prices</h3>
                <div class="entry-exit-row">
                    <div class="form-group">
                        <label for="customEntryPrice">Entry Price (USD)</label>
                        <input type="number" id="customEntryPrice" placeholder="Enter entry price" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="customExitPrice">Exit Price (USD)</label>
                        <input type="number" id="customExitPrice" placeholder="Enter exit price" step="0.01">
                    </div>
                </div>
                
                <label style="margin-top: 15px;">
                    <input type="checkbox" id="pointsCalculatorToggle"> P&L from Points Captured
                </label>
                <div id="pointsCalculatorPanel" class="points-calculator" style="display: none;">
                    <h3>Calculate P&L from Points Movement</h3>
                    <div class="entry-exit-row">
                        <div class="form-group">
                            <label for="pointsCaptured">Points Captured</label>
                            <input type="number" id="pointsCaptured" placeholder="Enter points (e.g., 50, 100)" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Direction</label>
                            <select id="pointsDirection">
                                <option value="profit">Profit Points</option>
                                <option value="loss">Loss Points</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- NEW FEATURES -->
            <!-- Advanced Analysis Section -->
            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="advancedAnalysisToggle"> Advanced Analysis
                    </label>
                </div>
            </div>
            
            <div id="advancedAnalysisPanel" class="leverage-analysis" style="display: none;">
                <div class="analysis-tabs">
                    <div class="analysis-tab active" data-tab="leverage-analysis">All Leverage Analysis</div>
                    <div class="analysis-tab" data-tab="capital-percentage">Capital % Analysis</div>
                </div>
                
                <!-- Leverage Analysis Content -->
                <div class="analysis-content active" id="leverage-analysis">
                    <h3>All Leverage Points Analysis (1x to 200x)</h3>
                    <div class="entry-exit-row">
                        <div class="form-group">
                            <label for="leverageAnalysisEntry">Entry Price (USD)</label>
                            <input type="number" id="leverageAnalysisEntry" placeholder="Enter entry price" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="leverageAnalysisExit">Target/Exit Price (USD)</label>
                            <input type="number" id="leverageAnalysisExit" placeholder="Enter target price" step="0.01">
                        </div>
                    </div>
                </div>
                
                <!-- Capital Percentage Analysis Content -->
                <div class="analysis-content" id="capital-percentage">
                    <h3>Capital Percentage Based P&L Analysis</h3>
                    <div class="entry-exit-row">
                        <div class="form-group">
                            <label for="maxCapitalPercentage">Max Capital % Change</label>
                            <input type="number" id="maxCapitalPercentage" placeholder="Enter max % (e.g., 10)" value="10" step="0.1" min="0.1" max="100">
                        </div>
                        <div class="form-group">
                            <label for="capitalPercentageStep">Step Size (%)</label>
                            <input type="number" id="capitalPercentageStep" placeholder="Enter step (e.g., 1)" value="1" step="0.1" min="0.1" max="10">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="results" class="results" style="display: none;">
                <div class="result-row">
                    <span class="result-label">Current Leverage</span>
                    <span id="currentLeverage" class="result-value"></span>
                </div>
                <div class="result-row">
                    <span class="result-label">Position Size</span>
                    <span id="positionSize" class="result-value"></span>
                </div>
                <div class="result-row">
                    <span class="result-label">Notional Value</span>
                    <span id="notionalValue" class="result-value"></span>
                </div>
                <div class="result-row">
                    <span class="result-label">Margin Required</span>
                    <span id="marginRequired" class="result-value"></span>
                </div>
                <div class="result-row">
                    <span class="result-label">Trading Fee (Round Trip)</span>
                    <span id="tradingFee" class="result-value"></span>
                </div>
                <div class="result-row">
                    <span class="result-label">Liquidation Price (Est.)</span>
                    <span id="liquidationPrice" class="result-value"></span>
                </div>
            </div>
            
            <div class="scenarios-container">
                <h2 id="scenariosTitle">Profit & Loss Scenarios</h2>
                <table class="scenarios-table">
                    <thead>
                        <tr id="scenariosHeader">
                            <th>Scenario</th>
                            <th>Change</th>
                            <th>USD Move</th>
                            <th>Exit Price</th>
                            <th>P&L (USD)</th>
                            <th>P&L (INR)</th>
                            <th>ROI %</th>
                            <th>P&L/Capital %</th>
                        </tr>
                    </thead>
                    <tbody id="scenariosTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
// Global variables
let currentExchangeRate = 83.25;
let isShortPosition = false;
let isMakerOrder = false;
let currentLeverageValue = 10;
let entryPrice = 0;
let capitalUSD = 0;
let isCustomEntryExit = false;
let isPointsCalculator = false;
let isAdvancedAnalysis = false;
let activeAnalysisTab = 'leverage-analysis';

const contractSymbols = {
    'bitcoin': 'BTC',
    'ethereum': 'ETH',
    'binancecoin': 'BNB',
    'solana': 'SOL',
    'ripple': 'XRP',
    'cardano': 'ADA',
    'polkadot': 'DOT',
    'chainlink': 'LINK',
    'avalanche-2': 'AVAX',
    'dogecoin': 'DOGE'
};

// DOM elements
const elements = {
    contract: document.getElementById('contract'),
    entryPrice: document.getElementById('entryPrice'),
    priceStatus: document.getElementById('priceStatus'),
    capitalUSD: document.getElementById('capitalUSD'),
    capitalINR: document.getElementById('capitalINR'),
    directionToggle: document.getElementById('directionToggle'),
    orderTypeToggle: document.getElementById('orderTypeToggle'),
    leverage: document.getElementById('leverage'),
    customLeverage: document.getElementById('customLeverage'),
    leverageWarning: document.getElementById('leverageWarning'),
    results: document.getElementById('results'),
    currentLeverage: document.getElementById('currentLeverage'),
    positionSize: document.getElementById('positionSize'),
    notionalValue: document.getElementById('notionalValue'),
    marginRequired: document.getElementById('marginRequired'),
    tradingFee: document.getElementById('tradingFee'),
    liquidationPrice: document.getElementById('liquidationPrice'),
    scenariosTableBody: document.getElementById('scenariosTableBody'),
    exchangeRateDisplay: document.getElementById('exchangeRateDisplay'),
    manualPriceToggle: document.getElementById('manualPriceToggle'),
    
    // Original features
    customEntryExitToggle: document.getElementById('customEntryExitToggle'),
    customEntryExitPanel: document.getElementById('customEntryExitPanel'),
    customEntryPrice: document.getElementById('customEntryPrice'),
    customExitPrice: document.getElementById('customExitPrice'),
    pointsCalculatorToggle: document.getElementById('pointsCalculatorToggle'),
    pointsCalculatorPanel: document.getElementById('pointsCalculatorPanel'),
    pointsCaptured: document.getElementById('pointsCaptured'),
    pointsDirection: document.getElementById('pointsDirection'),
    
    // New features
    advancedAnalysisToggle: document.getElementById('advancedAnalysisToggle'),
    advancedAnalysisPanel: document.getElementById('advancedAnalysisPanel'),
    leverageAnalysisEntry: document.getElementById('leverageAnalysisEntry'),
    leverageAnalysisExit: document.getElementById('leverageAnalysisExit'),
    maxCapitalPercentage: document.getElementById('maxCapitalPercentage'),
    capitalPercentageStep: document.getElementById('capitalPercentageStep'),
    
    scenariosTitle: document.getElementById('scenariosTitle'),
    scenariosHeader: document.getElementById('scenariosHeader')
};

// API Functions
async function fetchExchangeRate() {
    try {
        const response = await fetch('https://cdn.jsdelivr.net/npm/fawazahmed0@currency-api@latest/v1/currencies/usd.json');
        const data = await response.json();
        currentExchangeRate = data.usd.inr;
    } catch {
        // Fallback rate
    }
    elements.exchangeRateDisplay.textContent = `1 USD = ₹${currentExchangeRate.toFixed(2)}`;
}

async function fetchCryptoPrices() {
    if (elements.manualPriceToggle.checked) return;
    
    elements.priceStatus.textContent = '●';
    elements.priceStatus.classList.add('live-indicator');
    
    try {
        const contractId = elements.contract.value;
        const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${contractId}&vs_currencies=usd`);
        const data = await response.json();
        
        entryPrice = data[contractId].usd;
        elements.entryPrice.value = entryPrice.toFixed(2);
        elements.priceStatus.textContent = '●';
        elements.priceStatus.classList.add('live-indicator');
    } catch {
        elements.priceStatus.textContent = 'Error';
        elements.priceStatus.classList.remove('live-indicator');
    }
    
    calculateAndDisplay();
}

// Utility Functions
function syncCapitalUSD() {
    capitalUSD = parseFloat(elements.capitalUSD.value) || 0;
    elements.capitalINR.value = (capitalUSD * currentExchangeRate).toFixed(2);
    calculateAndDisplay();
}

function syncCapitalINR() {
    const val = parseFloat(elements.capitalINR.value) || 0;
    capitalUSD = val / currentExchangeRate;
    elements.capitalUSD.value = capitalUSD.toFixed(2);
    calculateAndDisplay();
}

function toggleDirection() {
    isShortPosition = !isShortPosition;
    elements.directionToggle.classList.toggle('active', isShortPosition);
    calculateAndDisplay();
}

function toggleOrderType() {
    isMakerOrder = !isMakerOrder;
    elements.orderTypeToggle.classList.toggle('active', isMakerOrder);
    calculateAndDisplay();
}

function handleLeverageChange() {
    const value = elements.leverage.value;
    if (value === 'custom') {
        elements.customLeverage.style.display = 'block';
        currentLeverageValue = parseFloat(elements.customLeverage.value) || 1;
    } else {
        elements.customLeverage.style.display = 'none';
        currentLeverageValue = parseFloat(value);
    }
    elements.leverageWarning.style.display = currentLeverageValue >= 50 ? 'block' : 'none';
    calculateAndDisplay();
}

function toggleCustomEntryExit() {
    isCustomEntryExit = elements.customEntryExitToggle.checked;
    elements.customEntryExitPanel.style.display = isCustomEntryExit ? 'block' : 'none';
    updateTableHeaders();
    calculateAndDisplay();
}

function togglePointsCalculator() {
    isPointsCalculator = elements.pointsCalculatorToggle.checked;
    elements.pointsCalculatorPanel.style.display = isPointsCalculator ? 'block' : 'none';
    updateTableHeaders();
    calculateAndDisplay();
}

function toggleAdvancedAnalysis() {
    isAdvancedAnalysis = elements.advancedAnalysisToggle.checked;
    elements.advancedAnalysisPanel.style.display = isAdvancedAnalysis ? 'block' : 'none';
    updateTableHeaders();
    calculateAndDisplay();
}

function switchAnalysisTab(tabName) {
    activeAnalysisTab = tabName;
    
    // Update tab appearance
    document.querySelectorAll('.analysis-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
    });
    
    // Update content visibility
    document.querySelectorAll('.analysis-content').forEach(content => {
        content.classList.toggle('active', content.id === tabName);
    });
    
    updateTableHeaders();
    calculateAndDisplay();
}

function updateTableHeaders() {
    if (isAdvancedAnalysis) {
        if (activeAnalysisTab === 'leverage-analysis') {
            elements.scenariosTitle.textContent = 'All Leverage Points Analysis (1x to 200x)';
            elements.scenariosHeader.innerHTML = `
                <th>Leverage</th>
                <th>Position Size</th>
                <th>Margin Required</th>
                <th>Round Trip Fee</th>
                <th>P&L (USD)</th>
                <th>P&L (INR)</th>
                <th>ROI %</th>
                <th>P&L/Capital %</th>
            `;
        } else if (activeAnalysisTab === 'capital-percentage') {
            elements.scenariosTitle.textContent = 'Capital Percentage Based P&L Analysis';
            elements.scenariosHeader.innerHTML = `
                <th>Scenario</th>
                <th>Change %</th>
                <th>USD Move</th>
                <th>Exit Price</th>
                <th>P&L (USD)</th>
                <th>P&L (INR)</th>
                <th>ROI %</th>
                <th>P&L/Capital %</th>
            `;
        }
    } else if (isPointsCalculator) {
        elements.scenariosTitle.textContent = 'Points-Based P&L Analysis';
        elements.scenariosHeader.innerHTML = `
            <th>Analysis</th>
            <th>Points</th>
            <th>Direction</th>
            <th>P&L (USD)</th>
            <th>P&L (INR)</th>
            <th>ROI %</th>
            <th>P&L/Capital %</th>
        `;
    } else if (isCustomEntryExit) {
        elements.scenariosTitle.textContent = 'Custom Entry & Exit Analysis';
        elements.scenariosHeader.innerHTML = `
            <th>Analysis</th>
            <th>Entry Price</th>
            <th>Exit Price</th>
            <th>Change %</th>
            <th>USD Move</th>
            <th>P&L (USD)</th>
            <th>P&L (INR)</th>
            <th>ROI %</th>
            <th>P&L/Capital %</th>
        `;
    } else {
        elements.scenariosTitle.textContent = 'Profit & Loss Scenarios';
        elements.scenariosHeader.innerHTML = `
            <th>Scenario</th>
            <th>Change</th>
            <th>USD Move</th>
            <th>Exit Price</th>
            <th>P&L (USD)</th>
            <th>P&L (INR)</th>
            <th>ROI %</th>
            <th>P&L/Capital %</th>
        `;
    }
}

// Event Listeners for new features
elements.customLeverage.addEventListener('input', () => {
    if (elements.leverage.value === 'custom') {
        currentLeverageValue = parseFloat(elements.customLeverage.value) || 1;
        elements.leverageWarning.style.display = currentLeverageValue >= 50 ? 'block' : 'none';
        calculateAndDisplay();
    }
});

elements.manualPriceToggle.addEventListener('change', () => {
    if (elements.manualPriceToggle.checked) {
        elements.entryPrice.readOnly = false;
        elements.priceStatus.textContent = 'Manual Input';
        elements.priceStatus.classList.remove('live-indicator');
    } else {
        elements.entryPrice.readOnly = true;
        elements.priceStatus.textContent = '●';
        elements.priceStatus.classList.add('live-indicator');
        fetchCryptoPrices();
    }
    calculateAndDisplay();
});

elements.customEntryExitToggle.addEventListener('change', toggleCustomEntryExit);
elements.pointsCalculatorToggle.addEventListener('change', togglePointsCalculator);
elements.advancedAnalysisToggle.addEventListener('change', toggleAdvancedAnalysis);

elements.entryPrice.addEventListener('input', () => {
    if (elements.manualPriceToggle.checked) {
        entryPrice = parseFloat(elements.entryPrice.value) || 0;
        calculateAndDisplay();
    }
});

elements.customEntryPrice.addEventListener('input', calculateAndDisplay);
elements.customExitPrice.addEventListener('input', calculateAndDisplay);
elements.pointsCaptured.addEventListener('input', calculateAndDisplay);
elements.pointsDirection.addEventListener('change', calculateAndDisplay);

// New feature event listeners
elements.leverageAnalysisEntry.addEventListener('input', calculateAndDisplay);
elements.leverageAnalysisExit.addEventListener('input', calculateAndDisplay);
elements.maxCapitalPercentage.addEventListener('input', calculateAndDisplay);
elements.capitalPercentageStep.addEventListener('input', calculateAndDisplay);

// Analysis tab switching
document.querySelectorAll('.analysis-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        switchAnalysisTab(tab.dataset.tab);
    });
});

// Main Calculation Function
function calculateAndDisplay() {
    fetchExchangeRate();
    
    if (!capitalUSD || !entryPrice || !currentLeverageValue) {
        elements.results.style.display = 'none';
        elements.scenariosTableBody.innerHTML = '';
        return;
    }
    
    // Basic calculations
    const positionValue = capitalUSD * currentLeverageValue;
    const positionSizeTokens = positionValue / entryPrice;
    const feeRate = isMakerOrder ? 0.0002 : 0.0005;
    const roundTripFeeUSD = positionValue * feeRate * 2; // Round trip = entry + exit
    const marginRequiredUSD = capitalUSD;
    
    // Liquidation price calculation
    const liquidationBuffer = 1 / currentLeverageValue * 0.9;
    const liquidationPrice = isShortPosition ? 
        entryPrice * (1 + liquidationBuffer) : 
        entryPrice * (1 - liquidationBuffer);
    
    // Update display
    elements.currentLeverage.textContent = `${currentLeverageValue}x`;
    elements.positionSize.textContent = `${positionSizeTokens.toFixed(6)} ${contractSymbols[elements.contract.value]}`;
    elements.notionalValue.innerHTML = `$${positionValue.toLocaleString()}<span class="currency-display">₹${(positionValue * currentExchangeRate).toLocaleString()}</span>`;
    elements.marginRequired.innerHTML = `$${marginRequiredUSD.toFixed(2)}<span class="currency-display">₹${(marginRequiredUSD * currentExchangeRate).toFixed(2)}</span>`;
    elements.tradingFee.innerHTML = `$${roundTripFeeUSD.toFixed(2)}<span class="currency-display">₹${(roundTripFeeUSD * currentExchangeRate).toFixed(2)}</span>`;
    elements.liquidationPrice.textContent = `$${liquidationPrice.toFixed(2)} (${isShortPosition ? '+' : '-'}${(liquidationBuffer * 100).toFixed(2)}%)`;
    
    elements.results.style.display = 'block';
    
    // Generate appropriate scenarios
    if (isAdvancedAnalysis) {
        if (activeAnalysisTab === 'leverage-analysis') {
            generateAllLeverageAnalysis(roundTripFeeUSD);
        } else if (activeAnalysisTab === 'capital-percentage') {
            generateCapitalPercentageAnalysis(positionSizeTokens, roundTripFeeUSD);
        }
    } else if (isPointsCalculator) {
        generatePointsScenarios(positionSizeTokens, roundTripFeeUSD);
    } else if (isCustomEntryExit) {
        generateCustomScenarios(positionSizeTokens, roundTripFeeUSD);
    } else {
        generateScenarios(positionSizeTokens, roundTripFeeUSD);
    }
}

// NEW: Generate All Leverage Analysis (1x to 200x)
function generateAllLeverageAnalysis(baseTradingFee) {
    const analysisEntry = parseFloat(elements.leverageAnalysisEntry.value) || 0;
    const analysisExit = parseFloat(elements.leverageAnalysisExit.value) || 0;
    
    if (!analysisEntry || !analysisExit) {
        elements.scenariosTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; opacity: 0.7;">Enter both entry and exit prices to see all leverage analysis</td></tr>';
        return;
    }
    
    let scenariosHTML = '';
    
    // Generate analysis for leverage 1x to 200x
    for (let lev = 1; lev <= 200; lev++) {
        const leverageValue = lev;
        const positionValue = capitalUSD * leverageValue;
        const positionSizeTokens = positionValue / analysisEntry;
        const feeRate = isMakerOrder ? 0.0002 : 0.0005;
        const roundTripFeeUSD = positionValue * feeRate * 2;
        const marginRequired = capitalUSD;
        
        // Calculate P&L for this leverage level
        const priceChangeUSD = analysisExit - analysisEntry;
        const pnl = isShortPosition ? 
            (analysisEntry - analysisExit) * positionSizeTokens - roundTripFeeUSD :
            (analysisExit - analysisEntry) * positionSizeTokens - roundTripFeeUSD;
        
        const roi = (pnl / capitalUSD) * 100;
        const pnlToCapitalPercent = (pnl / capitalUSD) * 100;
        const pnlClass = pnl >= 0 ? 'profit' : 'loss';
        
        scenariosHTML += `
            <tr>
                <td><strong>${leverageValue}x</strong></td>
                <td>${positionSizeTokens.toFixed(6)}</td>
                <td>$${marginRequired.toFixed(2)}</td>
                <td>$${roundTripFeeUSD.toFixed(2)}</td>
                <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                <td class="${pnlClass}">₹${(pnl * currentExchangeRate).toFixed(2)}</td>
                <td class="${pnlClass}">${roi.toFixed(2)}%</td>
                <td class="${pnlClass}">${pnlToCapitalPercent.toFixed(2)}%</td>
            </tr>
        `;
    }
    
    elements.scenariosTableBody.innerHTML = scenariosHTML;
}

// NEW: Generate Capital Percentage Analysis
function generateCapitalPercentageAnalysis(positionSize, tradingFee) {
    const maxPercent = parseFloat(elements.maxCapitalPercentage.value) || 10;
    const stepSize = parseFloat(elements.capitalPercentageStep.value) || 1;
    
    let scenariosHTML = '';
    
    // Generate scenarios from -maxPercent to +maxPercent with stepSize increments
    for (let percent = -maxPercent; percent <= maxPercent; percent += stepSize) {
        if (percent === 0) continue; // Skip 0% change
        
        // Calculate what price change would result in this capital percentage change
        // P&L = (price_change * position_size - trading_fee)
        // Required P&L for capital percentage = (capital * percent / 100)
        const requiredPnL = capitalUSD * (percent / 100);
        const requiredPriceChange = (requiredPnL + tradingFee) / positionSize;
        
        let exitPrice, actualPnL;
        if (isShortPosition) {
            exitPrice = entryPrice - requiredPriceChange;
            actualPnL = (entryPrice - exitPrice) * positionSize - tradingFee;
        } else {
            exitPrice = entryPrice + requiredPriceChange;
            actualPnL = (exitPrice - entryPrice) * positionSize - tradingFee;
        }
        
        const usdMove = exitPrice - entryPrice;
        const roi = (actualPnL / capitalUSD) * 100;
        const pnlToCapitalPercent = (actualPnL / capitalUSD) * 100;
        const pnlClass = actualPnL >= 0 ? 'profit' : 'loss';
        
        const scenarioLabel = percent > 0 ? 
            (isShortPosition ? 'Short Loss' : 'Long Profit') :
            (isShortPosition ? 'Short Profit' : 'Long Loss');
        
        const usdMoveDisp = usdMove >= 0 ? `+$${usdMove.toFixed(2)}` : `$${usdMove.toFixed(2)}`;
        const percentDisplay = percent > 0 ? `+${percent.toFixed(1)}%` : `${percent.toFixed(1)}%`;
        
        scenariosHTML += `
            <tr>
                <td><strong>${scenarioLabel}</strong></td>
                <td>${percentDisplay}</td>
                <td>${usdMoveDisp}</td>
                <td>$${exitPrice.toFixed(2)}</td>
                <td class="${pnlClass}">$${actualPnL.toFixed(2)}</td>
                <td class="${pnlClass}">₹${(actualPnL * currentExchangeRate).toFixed(2)}</td>
                <td class="${pnlClass}">${roi.toFixed(2)}%</td>
                <td class="${pnlClass}">${pnlToCapitalPercent.toFixed(2)}%</td>
            </tr>
        `;
    }
    
    elements.scenariosTableBody.innerHTML = scenariosHTML;
}

// Original scenario generation functions (preserved)
function generatePointsScenarios(positionSize, tradingFee) {
    const points = parseFloat(elements.pointsCaptured.value) || 0;
    const direction = elements.pointsDirection.value;
    
    if (!points) {
        elements.scenariosTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; opacity: 0.7;">Enter points to calculate P&L</td></tr>';
        return;
    }
    
    let pnl;
    if (direction === 'profit') {
        pnl = points * positionSize - tradingFee;
    } else {
        pnl = -points * positionSize - tradingFee;
    }
    
    const roi = (pnl / capitalUSD) * 100;
    const pnlToCapitalPercent = (pnl / capitalUSD) * 100;
    const pnlClass = pnl >= 0 ? 'profit' : 'loss';
    const directionText = direction === 'profit' ? 'Profit' : 'Loss';
    const positionType = isShortPosition ? 'Short Position' : 'Long Position';
    
    const scenariosHTML = `
        <tr>
            <td><strong>${positionType}</strong></td>
            <td>${points.toFixed(2)}</td>
            <td>${directionText}</td>
            <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
            <td class="${pnlClass}">₹${(pnl * currentExchangeRate).toFixed(2)}</td>
            <td class="${pnlClass}">${roi.toFixed(2)}%</td>
            <td class="${pnlClass}">${pnlToCapitalPercent.toFixed(2)}%</td>
        </tr>
    `;
    
    elements.scenariosTableBody.innerHTML = scenariosHTML;
}

function generateCustomScenarios(positionSize, tradingFee) {
    const customEntry = parseFloat(elements.customEntryPrice.value) || 0;
    const customExit = parseFloat(elements.customExitPrice.value) || 0;
    
    if (!customEntry || !customExit) {
        elements.scenariosTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; opacity: 0.7;">Enter both entry and exit prices to see analysis</td></tr>';
        return;
    }
    
    const priceChangeUSD = customExit - customEntry;
    const priceChangePercent = ((customExit - customEntry) / customEntry) * 100;
    
    const pnl = isShortPosition ? 
        (customEntry - customExit) * positionSize - tradingFee :
        (customExit - customEntry) * positionSize - tradingFee;
    
    const roi = (pnl / capitalUSD) * 100;
    const pnlToCapitalPercent = (pnl / capitalUSD) * 100;
    const pnlClass = pnl >= 0 ? 'profit' : 'loss';
    const direction = isShortPosition ? 'Short Position' : 'Long Position';
    
    const priceChangeDisplay = priceChangeUSD >= 0 ? `+$${priceChangeUSD.toFixed(2)}` : `$${priceChangeUSD.toFixed(2)}`;
    const percentDisplay = priceChangePercent >= 0 ? `+${priceChangePercent.toFixed(2)}%` : `${priceChangePercent.toFixed(2)}%`;
    
    const scenariosHTML = `
        <tr>
            <td><strong>${direction}</strong></td>
            <td>$${customEntry.toFixed(2)}</td>
            <td>$${customExit.toFixed(2)}</td>
            <td>${percentDisplay}</td>
            <td>${priceChangeDisplay}</td>
            <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
            <td class="${pnlClass}">₹${(pnl * currentExchangeRate).toFixed(2)}</td>
            <td class="${pnlClass}">${roi.toFixed(2)}%</td>
            <td class="${pnlClass}">${pnlToCapitalPercent.toFixed(2)}%</td>
        </tr>
    `;
    
    elements.scenariosTableBody.innerHTML = scenariosHTML;
}

function generateScenarios(positionSize, tradingFee) {
    let scenariosHTML = '';
    
    for (let percentage = 1; percentage <= 10; percentage++) {
        // Positive price change
        let positiveChange = percentage / 100;
        let positiveExitPrice = isShortPosition ? 
            entryPrice * (1 - positiveChange) : 
            entryPrice * (1 + positiveChange);
        let positivePnL = isShortPosition ? 
            (entryPrice - positiveExitPrice) * positionSize - tradingFee :
            (positiveExitPrice - entryPrice) * positionSize - tradingFee;
        let positiveROI = (positivePnL / capitalUSD) * 100;
        let positivePnLToCapital = (positivePnL / capitalUSD) * 100;
        
        // Real USD Movement
        let posUsdMove = positiveExitPrice - entryPrice;
        let posUsdMoveDisp = posUsdMove >= 0 ? `+$${posUsdMove.toFixed(2)}` : `$${posUsdMove.toFixed(2)}`;
        
        // Negative price change
        let negativeChange = -percentage / 100;
        let negativeExitPrice = isShortPosition ? 
            entryPrice * (1 - negativeChange) : 
            entryPrice * (1 + negativeChange);
        let negativePnL = isShortPosition ? 
            (entryPrice - negativeExitPrice) * positionSize - tradingFee :
            (negativeExitPrice - entryPrice) * positionSize - tradingFee;
        let negativeROI = (negativePnL / capitalUSD) * 100;
        let negativePnLToCapital = (negativePnL / capitalUSD) * 100;
        
        let negUsdMove = negativeExitPrice - entryPrice;
        let negUsdMoveDisp = negUsdMove >= 0 ? `+$${negUsdMove.toFixed(2)}` : `$${negUsdMove.toFixed(2)}`;
        
        let positiveLabel = isShortPosition ? 'Take Profit (Short)' : 'Take Profit';
        let negativeLabel = isShortPosition ? 'Stop Loss (Short)' : 'Stop Loss';
        
        scenariosHTML += `
            <tr>
                <td>${positiveLabel}</td>
                <td>+${percentage}%</td>
                <td>${posUsdMoveDisp}</td>
                <td>$${positiveExitPrice.toFixed(2)}</td>
                <td class="${positivePnL >= 0 ? 'profit' : 'loss'}">$${positivePnL.toFixed(2)}</td>
                <td class="${positivePnL >= 0 ? 'profit' : 'loss'}">₹${(positivePnL * currentExchangeRate).toFixed(2)}</td>
                <td class="${positivePnL >= 0 ? 'profit' : 'loss'}">${positiveROI.toFixed(2)}%</td>
                <td class="${positivePnL >= 0 ? 'profit' : 'loss'}">${positivePnLToCapital.toFixed(2)}%</td>
            </tr>
            <tr>
                <td>${negativeLabel}</td>
                <td>-${percentage}%</td>
                <td>${negUsdMoveDisp}</td>
                <td>$${negativeExitPrice.toFixed(2)}</td>
                <td class="${negativePnL >= 0 ? 'profit' : 'loss'}">$${negativePnL.toFixed(2)}</td>
                <td class="${negativePnL >= 0 ? 'profit' : 'loss'}">₹${(negativePnL * currentExchangeRate).toFixed(2)}</td>
                <td class="${negativePnL >= 0 ? 'profit' : 'loss'}">${negativeROI.toFixed(2)}%</td>
                <td class="${negativePnL >= 0 ? 'profit' : 'loss'}">${negativePnLToCapital.toFixed(2)}%</td>
            </tr>
        `;
    }
    
    elements.scenariosTableBody.innerHTML = scenariosHTML;
}

// Event listeners
elements.contract.addEventListener('change', () => {
    if (!elements.manualPriceToggle.checked) {
        fetchCryptoPrices();
    } else {
        calculateAndDisplay();
    }
});

elements.capitalUSD.addEventListener('input', syncCapitalUSD);
elements.capitalINR.addEventListener('input', syncCapitalINR);
elements.directionToggle.addEventListener('click', toggleDirection);
elements.orderTypeToggle.addEventListener('click', toggleOrderType);
elements.leverage.addEventListener('change', handleLeverageChange);

// Initialize page
fetchExchangeRate();
fetchCryptoPrices();

// Auto refresh intervals
setInterval(fetchCryptoPrices, 30000); // 30 seconds
setInterval(fetchExchangeRate, 60000); // 1 minute
</script>
</body>
</html>
